---
.docker-base:
  retry: 1
  stage: docker
  image: docker:stable
  services:
  - name: docker:dind
    alias: docker
  variables:
    IMAGE_TAG: $CI_REGISTRY_IMAGE/$CI_JOB_NAME:$CI_COMMIT_REF_SLUG
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_VERIFY: 1
  before_script:
  - docker info
  - OLDDIR=$(pwd)
  - cd $DOCKER_BASEDIR/.ci/dockerfiles/$CI_JOB_NAME
  - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  - docker pull $(grep '^FROM' Dockerfile | cut -d ' ' -f 2)
  - docker pull $IMAGE_TAG || true
  - cd $OLDDIR
  script:
  - OLDDIR=$(pwd)
  - cd $DOCKER_BASEDIR/.ci/dockerfiles/$CI_JOB_NAME
  - JOB_NAME_SAFE=$(echo $CI_JOB_NAME|sed "s/-/_/g")
  - USE_ACNG=$(eval echo "\$USE_ACNG_$JOB_NAME_SAFE")
  - if [ ! -z "$USE_ACNG" ]; then proxy_args="--build-arg=http_proxy=$ACNG --build-arg=https_proxy=$ACNG"; else proxy_args=""; fi
  - echo "$proxy_args"
  - docker build --pull --cache-from $IMAGE_TAG $proxy_args -t $IMAGE_TAG .
  - docker push $IMAGE_TAG
  - cd $OLDDIR
  after_script:
  - docker logout $CI_REGISTRY

.docker-base-arm:
  extends: .docker-base
  tags:
  - dind
  - arm

.docker-base-x86:
  extends: .docker-base
  tags:
  - dind
  - x86
